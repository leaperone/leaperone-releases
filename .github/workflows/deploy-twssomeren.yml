name: Deploy TwoSOMEren

on:
  repository_dispatch:
    types: [deploy-twssomeren]


env:
  DOCKERHUB: registry.cn-guangzhou.aliyuncs.com/leaperone/2someone
  BUILD_DATE: ${{ format('YYYYMMDD', github.event.client_payload.timestamp || github.event.timestamp) }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ACCESS_TOKEN }}
          repository: leaper-one/2SOMEren
          ref: ${{ github.event.client_payload.ref || github.ref }}

      - name: Check Skip CI
        run: |
          if grep -q "noci" <<< "${{ github.event.client_payload.message || '' }}"; then
            echo "è·³è¿‡æž„å»º: commit message åŒ…å« 'noci'"
            exit 78
          fi

      - name: Login to Aliyun Docker Registry
        uses: docker/login-action@v3
        with:
          registry: registry.cn-guangzhou.aliyuncs.com
          username: ${{ secrets.ALIYUN_DOCKER_USERNAME }}
          password: ${{ secrets.ALIYUN_DOCKER_PASSWORD }}

      - name: Set up Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose-plugin
          docker compose version

      - name: Build Docker images
        run: docker compose -f ./docker/docker-compose-build.yml build

      - name: Tag and Push Docker images
        run: |
          docker tag ${DOCKERHUB}:web-${GITHUB_REF_NAME}-latest-${GITHUB_RUN_NUMBER} ${DOCKERHUB}:web-${GITHUB_REF_NAME}-latest
          docker push ${DOCKERHUB}:web-${GITHUB_REF_NAME}-latest

      - name: Run Database Migrations
        if: github.ref == 'refs/heads/main'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: |
          npm install -g prisma --registry https://registry.npmmirror.com
          export TWOSOMEREN_DATABASE_URL="${{ secrets.TWOSOMEREN_DATABASE_URL }}"
          export TWOSOMEREN_BILI_DATABASE_URL="${{ secrets.TWOSOMEREN_BILI_DATABASE_URL }}"
          sh prisma/migrate_deploy.sh

      - name: Deploy to Production
        if: github.ref == 'refs/heads/main'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.ALIYUN_CN_HOST }}
          username: ${{ secrets.ALIYUN_CN_USERNAME }}
          port: ${{ secrets.ALIYUN_CN_PORT }}
          key: ${{ secrets.ALIYUN_CN_SSH_PRIVATE_KEY }}
          script: ${{ secrets.DEPLOY_TWOSOMEREN_SCRIPT }}

      - name: Notify Feishu
        uses: foxundermoon/feishu-action@v2
        if: always()
        with:
          url: ${{ secrets.FEISHU_WEBHOOK_URL }}
          msg_type: card
          content: |
            header:
              template: ${{ job.status == 'success' && 'green' || 'red' }}
              title:
                content: "${{ job.status == 'success' && 'ðŸš€ éƒ¨ç½²æˆåŠŸå•¦ï¼' || 'âŒ éƒ¨ç½²å¤±è´¥äº†ï¼' }}"
                tag: plain_text
            elements:
            - tag: div
              text:
                content: "ðŸŒŸ éƒ¨ç½²è¯¦æƒ…\n\n**åˆ†æ”¯**ï¼š${{ github.event.client_payload.ref }}\n**æž„å»ºç¼–å·**ï¼š#${{ github.run_number }}\n**æäº¤ä¿¡æ¯**ï¼š${{ github.event.client_payload.message }}\n**æäº¤è€…**ï¼š${{ github.event.client_payload.author }}\n**æž„å»ºæ—¶é—´**ï¼š${{ env.BUILD_DATE }}"
                tag: lark_md
            - tag: hr
            - tag: div
              text:
                content: "${{ job.status == 'success' && 'âœ¨ éƒ¨ç½²å·²ç»å®Œæˆï¼Œå¿«åŽ»çœ‹çœ‹æ–°åŠŸèƒ½å§ï¼' || 'ðŸ˜± ç³Ÿç³•ï¼éƒ¨ç½²å‡ºçŽ°äº†é—®é¢˜ï¼Œè¯·åŠæ—¶æ£€æŸ¥ï¼' }}"
                tag: lark_md
            - tag: action
              actions:
                - tag: button
                  text:
                    content: "æŸ¥çœ‹è¯¦æƒ… ðŸ‘‰"
                    tag: plain_text
                  url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  type: "primary"
