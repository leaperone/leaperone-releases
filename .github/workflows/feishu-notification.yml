name: Feishu Notification

on:
  workflow_call:
    inputs:
      status:
        required: true
        type: string
      ref:
        required: true
        type: string
      run_number:
        required: true
        type: string
      message:
        required: false
        type: string
      author:
        required: false
        type: string
      run_id:
        required: true
        type: string
      pr_number:
        required: false
        type: string
        default: ''
      repository:
        description: 'æºä»£ç ä»“åº“ï¼Œæ ¼å¼ä¸º owner/repoï¼Œå¦‚ leaperone/LEAPERone'
        required: false
        type: string
        default: ''
    secrets:
      FEISHU_WEBHOOK_URL:
        required: true

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Feishu Notification
        run: |
          # æ„å»ºé£ä¹¦æ¶ˆæ¯å†…å®¹
          MESSAGE_CONTENT=$(cat << EOF
          {
            "msg_type": "interactive",
            "card": {
              "header": {
                "title": {
                  "content": "${{ inputs.status == 'success' && 'ğŸš€ éƒ¨ç½²æˆåŠŸå•¦ï¼' || 'âŒ éƒ¨ç½²å¤±è´¥äº†ï¼' }}",
                  "tag": "plain_text"
                }
              },
              "elements": [
                {
                  "tag": "div",
                  "text": {
                    "content": "ğŸŒŸ éƒ¨ç½²è¯¦æƒ…\n\n**åˆ†æ”¯**ï¼š${{ inputs.ref }}\n**æ„å»ºç¼–å·**ï¼š#${{ inputs.run_number }}\n**æäº¤ä¿¡æ¯**ï¼š${{ inputs.message }}\n**æäº¤è€…**ï¼š${{ inputs.author }}",
                    "tag": "lark_md"
                  }
                },
                {
                  "tag": "hr"
                },
                {
                  "tag": "div",
                  "text": {
                    "content": "${{ inputs.status == 'success' && 'âœ¨ éƒ¨ç½²å·²ç»å®Œæˆï¼Œå¿«å»çœ‹çœ‹æ–°åŠŸèƒ½å§ï¼' || 'ğŸ˜± ç³Ÿç³•ï¼éƒ¨ç½²å‡ºç°äº†é—®é¢˜ï¼Œè¯·åŠæ—¶æ£€æŸ¥ï¼<at id=all></at>' }}",
                    "tag": "lark_md"
                  }
                },
                {
                  "tag": "action",
                  "actions": [
                    {
                      "tag": "button",
                      "text": {
                        "content": "æŸ¥çœ‹è¯¦æƒ… ğŸ‘‰",
                        "tag": "plain_text"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ inputs.run_id }}",
                      "type": "primary"
                    },
                    {
                      "tag": "button",
                      "text": {
                        "content": "æŸ¥çœ‹ä»£ç  ğŸ“‚",
                        "tag": "plain_text"
                      },
                      "url": "${{ inputs.pr_number != '' && inputs.repository != '' && format('{0}/{1}/pull/{2}', github.server_url, inputs.repository, inputs.pr_number) || inputs.repository != '' && format('{0}/{1}', github.server_url, inputs.repository) || format('{0}/{1}', github.server_url, github.repository) }}",
                      "type": "default"
                    }
                  ]
                }
              ]
            }
          }
          EOF
          )

          # ä½¿ç”¨ curl å‘é€è¯·æ±‚
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$MESSAGE_CONTENT" \
            ${{ secrets.FEISHU_WEBHOOK_URL }} 