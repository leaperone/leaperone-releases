name: Telegram Notification

on:
  workflow_call:
    inputs:
      status:
        required: true
        type: string
      ref:
        required: true
        type: string
      run_number:
        required: true
        type: string
      message:
        required: false
        type: string
      author:
        required: false
        type: string
      run_id:
        required: true
        type: string
      pr_number:
        required: false
        type: string
        default: ''
      repository:
        description: 'æºä»£ç ä»“åº“ï¼Œæ ¼å¼ä¸º owner/repo'
        required: false
        type: string
        default: ''
    secrets:
      TELEGRAM_BOT_TOKEN:
        required: true
      TELEGRAM_CHAT_ID:
        required: true
      ACCESS_TOKEN:
        required: false

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram Notification
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          STATUS: ${{ inputs.status }}
          REF: ${{ inputs.ref }}
          RUN_NUMBER: ${{ inputs.run_number }}
          MESSAGE: ${{ inputs.message }}
          AUTHOR: ${{ inputs.author }}
          RUN_ID: ${{ inputs.run_id }}
          PR_NUMBER: ${{ inputs.pr_number }}
          REPOSITORY: ${{ inputs.repository }}
          SERVER_URL: ${{ github.server_url }}
          GH_REPOSITORY: ${{ github.repository }}
          ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
        run: |
          # æå–é¡¹ç›®å
          PROJECT_NAME="${REPOSITORY##*/}"
          if [ -z "$PROJECT_NAME" ]; then
            PROJECT_NAME="${GH_REPOSITORY##*/}"
          fi

          # æŸ¥è¯¢ PR çŠ¶æ€
          PR_STATUS=""
          if [ -n "$PR_NUMBER" ] && [ -n "$REPOSITORY" ]; then
            AUTH_HEADER=""
            if [ -n "$ACCESS_TOKEN" ]; then
              AUTH_HEADER="Authorization: token ${ACCESS_TOKEN}"
            fi
            PR_DATA=$(curl -s -H "$AUTH_HEADER" "https://api.github.com/repos/${REPOSITORY}/pulls/${PR_NUMBER}")
            PR_STATE=$(echo "$PR_DATA" | jq -r '.state // empty')
            PR_MERGED=$(echo "$PR_DATA" | jq -r '.merged // false')
            PR_DRAFT=$(echo "$PR_DATA" | jq -r '.draft // false')

            if [ "$PR_MERGED" = "true" ]; then
              PR_STATUS="merged"
            elif [ "$PR_STATE" = "closed" ]; then
              PR_STATUS="closed"
            elif [ "$PR_DRAFT" = "true" ]; then
              PR_STATUS="draft"
            else
              PR_STATUS="open"
            fi
          fi

          # çŠ¶æ€ä¿¡æ¯
          if [ "$STATUS" = "success" ]; then
            TEXT="âœ… *${PROJECT_NAME}* éƒ¨ç½²æˆåŠŸ

          ğŸ“¦ \`${REF}\`
          ğŸ”¢ æ„å»º #${RUN_NUMBER}
          ğŸ’¬ ${MESSAGE}
          ğŸ‘¤ ${AUTHOR}"
          else
            TEXT="âŒ *${PROJECT_NAME}* éƒ¨ç½²å¤±è´¥

          ğŸ“¦ \`${REF}\`
          ğŸ”¢ æ„å»º #${RUN_NUMBER}
          ğŸ’¬ ${MESSAGE}
          ğŸ‘¤ ${AUTHOR}

          âš ï¸ è¯·åŠæ—¶æ£€æŸ¥ï¼"
          fi

          # æ„å»ºæŒ‰é’®
          ACTIONS_URL="${SERVER_URL}/${GH_REPOSITORY}/actions/runs/${RUN_ID}"

          if [ -n "$PR_NUMBER" ] && [ -n "$REPOSITORY" ]; then
            CODE_URL="${SERVER_URL}/${REPOSITORY}/pull/${PR_NUMBER}"
            CODE_LABEL="PR #${PR_NUMBER}"
          elif [ -n "$REPOSITORY" ]; then
            CODE_URL="${SERVER_URL}/${REPOSITORY}"
            CODE_LABEL="æºä»£ç "
          else
            CODE_URL="${SERVER_URL}/${GH_REPOSITORY}"
            CODE_LABEL="æºä»£ç "
          fi

          PR_URL="${SERVER_URL}/${REPOSITORY}/pull/${PR_NUMBER}"
          SQUASH_MSG="è¯·å°† ${PR_URL} å‹ç¼©åˆå¹¶"
          DROP_MSG="è¯·å°† ${PR_URL} å…³é—­"
          READY_MSG="è¯·å°† ${PR_URL} æ ‡è®°ä¸º ready for review"
          REOPEN_MSG="è¯·å°† ${PR_URL} é‡æ–°æ‰“å¼€"
          RERUN_URL="${SERVER_URL}/${GH_REPOSITORY}/actions/runs/${RUN_ID}"

          # ç¬¬ä¸€è¡Œï¼šé€šç”¨æŒ‰é’®ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰
          ROW1='[{"text":"ğŸ“‹ æ„å»ºæ—¥å¿—","url":"'"${ACTIONS_URL}"'"},{"text":"ğŸ’» '"${CODE_LABEL}"'","url":"'"${CODE_URL}"'"}]'

          # ç¬¬äºŒè¡Œï¼šæ ¹æ®æ„å»ºçŠ¶æ€å’Œ PR çŠ¶æ€å†³å®š
          ROW2=""
          if [ "$STATUS" != "success" ]; then
            # æ„å»ºå¤±è´¥ï¼šæ˜¾ç¤ºé‡æ–°è¿è¡Œ
            ROW2='[{"text":"ğŸ”„ é‡æ–°è¿è¡Œ","url":"'"${RERUN_URL}"'"}]'
          elif [ "$PR_STATUS" = "draft" ]; then
            # Draftï¼šReady for Review + Drop
            ROW2='[{"text":"ğŸ‘€ Ready","switch_inline_query_current_chat":"'"${READY_MSG}"'"},{"text":"ğŸ—‘ Drop","switch_inline_query_current_chat":"'"${DROP_MSG}"'"}]'
          elif [ "$PR_STATUS" = "open" ]; then
            # Openï¼šå‹ç¼©åˆå¹¶ + Drop
            ROW2='[{"text":"ğŸ”€ å‹ç¼©åˆå¹¶","switch_inline_query_current_chat":"'"${SQUASH_MSG}"'"},{"text":"ğŸ—‘ Drop","switch_inline_query_current_chat":"'"${DROP_MSG}"'"}]'
          elif [ "$PR_STATUS" = "closed" ]; then
            # Closedï¼šReopen
            ROW2='[{"text":"â™»ï¸ Reopen","switch_inline_query_current_chat":"'"${REOPEN_MSG}"'"}]'
          fi

          # ç»„è£… BUTTONS
          if [ -n "$ROW2" ]; then
            BUTTONS="[${ROW1},${ROW2}]"
          else
            BUTTONS="[${ROW1}]"
          fi

          # å‘é€æ¶ˆæ¯
          jq -n \
            --arg chat_id "$TG_CHAT_ID" \
            --arg text "$TEXT" \
            --argjson reply_markup "{\"inline_keyboard\": $BUTTONS}" \
            '{chat_id: $chat_id, parse_mode: "Markdown", text: $text, disable_web_page_preview: true, reply_markup: $reply_markup}' \
          | curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d @-
