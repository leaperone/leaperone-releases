name: Telegram Notification

on:
  workflow_call:
    inputs:
      status:
        required: true
        type: string
      ref:
        required: true
        type: string
      run_number:
        required: true
        type: string
      message:
        required: false
        type: string
      author:
        required: false
        type: string
      run_id:
        required: true
        type: string
      pr_number:
        required: false
        type: string
        default: ''
      repository:
        description: 'æºä»£ç ä»“åº“ï¼Œæ ¼å¼ä¸º owner/repo'
        required: false
        type: string
        default: ''
    secrets:
      TELEGRAM_BOT_TOKEN:
        required: true
      TELEGRAM_CHAT_ID:
        required: true

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram Notification
        run: |
          if [ "${{ inputs.status }}" = "success" ]; then
            EMOJI="âœ…"
            STATUS_TEXT="éƒ¨ç½²æˆåŠŸ"
            FOOTER="éƒ¨ç½²å·²å®Œæˆï¼Œå¿«å»çœ‹çœ‹æ–°åŠŸèƒ½å§ï¼"
          else
            EMOJI="âŒ"
            STATUS_TEXT="éƒ¨ç½²å¤±è´¥"
            FOOTER="éƒ¨ç½²å‡ºç°é—®é¢˜ï¼Œè¯·åŠæ—¶æ£€æŸ¥ï¼"
          fi

          ACTIONS_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ inputs.run_id }}"

          if [ -n "${{ inputs.pr_number }}" ] && [ -n "${{ inputs.repository }}" ]; then
            CODE_URL="${{ github.server_url }}/${{ inputs.repository }}/pull/${{ inputs.pr_number }}"
          elif [ -n "${{ inputs.repository }}" ]; then
            CODE_URL="${{ github.server_url }}/${{ inputs.repository }}"
          else
            CODE_URL="${{ github.server_url }}/${{ github.repository }}"
          fi

          TEXT="${EMOJI} *${STATUS_TEXT}*

ğŸ“¦ *åˆ†æ”¯*: \`${{ inputs.ref }}\`
ğŸ”¢ *æ„å»º*: #${{ inputs.run_number }}
ğŸ’¬ *æäº¤*: ${{ inputs.message }}
ğŸ‘¤ *æäº¤è€…*: ${{ inputs.author }}

${FOOTER}

[æŸ¥çœ‹è¯¦æƒ…](${ACTIONS_URL}) | [æŸ¥çœ‹ä»£ç ](${CODE_URL})"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg chat_id "${{ secrets.TELEGRAM_CHAT_ID }}" \
              --arg text "$TEXT" \
              '{chat_id: $chat_id, parse_mode: "Markdown", text: $text, disable_web_page_preview: true}')"
