name: Telegram Notification

on:
  workflow_call:
    inputs:
      status:
        required: true
        type: string
      ref:
        required: true
        type: string
      run_number:
        required: true
        type: string
      message:
        required: false
        type: string
      author:
        required: false
        type: string
      run_id:
        required: true
        type: string
      pr_number:
        required: false
        type: string
        default: ''
      repository:
        description: 'æºä»£ç ä»“åº“ï¼Œæ ¼å¼ä¸º owner/repo'
        required: false
        type: string
        default: ''
    secrets:
      TELEGRAM_BOT_TOKEN:
        required: true
      TELEGRAM_CHAT_ID:
        required: true

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram Notification
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          STATUS: ${{ inputs.status }}
          REF: ${{ inputs.ref }}
          RUN_NUMBER: ${{ inputs.run_number }}
          MESSAGE: ${{ inputs.message }}
          AUTHOR: ${{ inputs.author }}
          RUN_ID: ${{ inputs.run_id }}
          PR_NUMBER: ${{ inputs.pr_number }}
          REPOSITORY: ${{ inputs.repository }}
          SERVER_URL: ${{ github.server_url }}
          GH_REPOSITORY: ${{ github.repository }}
        run: |
          # æå–é¡¹ç›®å
          PROJECT_NAME="${REPOSITORY##*/}"
          if [ -z "$PROJECT_NAME" ]; then
            PROJECT_NAME="${GH_REPOSITORY##*/}"
          fi

          # çŠ¶æ€ä¿¡æ¯
          if [ "$STATUS" = "success" ]; then
            TEXT="âœ… *${PROJECT_NAME}* éƒ¨ç½²æˆåŠŸ

          ğŸ“¦ \`${REF}\`
          ğŸ”¢ æ„å»º #${RUN_NUMBER}
          ğŸ’¬ ${MESSAGE}
          ğŸ‘¤ ${AUTHOR}"
          else
            TEXT="âŒ *${PROJECT_NAME}* éƒ¨ç½²å¤±è´¥

          ğŸ“¦ \`${REF}\`
          ğŸ”¢ æ„å»º #${RUN_NUMBER}
          ğŸ’¬ ${MESSAGE}
          ğŸ‘¤ ${AUTHOR}

          âš ï¸ è¯·åŠæ—¶æ£€æŸ¥ï¼"
          fi

          # æ„å»ºæŒ‰é’®
          ACTIONS_URL="${SERVER_URL}/${GH_REPOSITORY}/actions/runs/${RUN_ID}"

          if [ -n "$PR_NUMBER" ] && [ -n "$REPOSITORY" ]; then
            CODE_URL="${SERVER_URL}/${REPOSITORY}/pull/${PR_NUMBER}"
            CODE_LABEL="PR #${PR_NUMBER}"
          elif [ -n "$REPOSITORY" ]; then
            CODE_URL="${SERVER_URL}/${REPOSITORY}"
            CODE_LABEL="æºä»£ç "
          else
            CODE_URL="${SERVER_URL}/${GH_REPOSITORY}"
            CODE_LABEL="æºä»£ç "
          fi

          # æ„å»º inline keyboard JSON
          BUTTONS='[
            [
              {"text":"ğŸ“‹ æ„å»ºæ—¥å¿—","url":"'"${ACTIONS_URL}"'"},
              {"text":"ğŸ’» '"${CODE_LABEL}"'","url":"'"${CODE_URL}"'"}
            ]
          ]'

          # æˆåŠŸ + æœ‰ PR æ—¶åŠ å‹ç¼©åˆå¹¶æŒ‰é’®
          if [ "$STATUS" = "success" ] && [ -n "$PR_NUMBER" ] && [ -n "$REPOSITORY" ]; then
            SQUASH_MSG="@Leo è¯·å°† ${SERVER_URL}/${REPOSITORY}/pull/${PR_NUMBER} å‹ç¼©åˆå¹¶"
            BUTTONS='[
              [
                {"text":"ğŸ“‹ æ„å»ºæ—¥å¿—","url":"'"${ACTIONS_URL}"'"},
                {"text":"ğŸ’» '"${CODE_LABEL}"'","url":"'"${CODE_URL}"'"}
              ],
              [
                {"text":"ğŸ”€ å‹ç¼©åˆå¹¶","switch_inline_query_current_chat":"'"${SQUASH_MSG}"'"}
              ]
            ]'
          fi

          # å¤±è´¥æ—¶åŠ ä¸€ä¸ª re-run æŒ‰é’®
          if [ "$STATUS" != "success" ]; then
            RERUN_URL="${SERVER_URL}/${GH_REPOSITORY}/actions/runs/${RUN_ID}"
            BUTTONS='[
              [
                {"text":"ğŸ“‹ æ„å»ºæ—¥å¿—","url":"'"${ACTIONS_URL}"'"},
                {"text":"ğŸ’» '"${CODE_LABEL}"'","url":"'"${CODE_URL}"'"}
              ],
              [
                {"text":"ğŸ”„ é‡æ–°è¿è¡Œ","url":"'"${RERUN_URL}"'"}
              ]
            ]'
          fi

          # å‘é€æ¶ˆæ¯
          jq -n \
            --arg chat_id "$TG_CHAT_ID" \
            --arg text "$TEXT" \
            --argjson reply_markup "{\"inline_keyboard\": $BUTTONS}" \
            '{chat_id: $chat_id, parse_mode: "Markdown", text: $text, disable_web_page_preview: true, reply_markup: $reply_markup}' \
          | curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d @-
