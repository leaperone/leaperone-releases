name: Deploy MultiPost

on:
  repository_dispatch:
    types: [deploy-multipost]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.set-ref.outputs.pr_number }}
    
    steps:
      - name: Validate and set ref
        id: set-ref
        run: |
          REF="${{ github.event.client_payload.ref }}"
          if [ -z "$REF" ]; then
            echo "ref=main" >> $GITHUB_OUTPUT
            echo "pr_number=" >> $GITHUB_OUTPUT
            echo "使用默认分支: main (ref 为空)"
          elif [[ "$REF" =~ ^([0-9]+)/merge ]]; then
            # 提取 PR 号，使用 PR 的 merge ref
            PR_NUMBER="${BASH_REMATCH[1]}"
            echo "ref=refs/pull/${PR_NUMBER}/merge" >> $GITHUB_OUTPUT
            echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
            echo "检测到 PR merge ref，使用 PR #${PR_NUMBER} 的 merge ref"
          elif [[ "$REF" == *"/merge"* ]]; then
            # 其他 merge 格式，尝试提取 PR 号
            PR_NUMBER=$(echo "$REF" | grep -oE '[0-9]+' | head -1)
            if [ -n "$PR_NUMBER" ]; then
              echo "ref=refs/pull/${PR_NUMBER}/merge" >> $GITHUB_OUTPUT
              echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
              echo "检测到 merge ref，使用 PR #${PR_NUMBER} 的 merge ref"
            else
              echo "ref=main" >> $GITHUB_OUTPUT
              echo "pr_number=" >> $GITHUB_OUTPUT
              echo "无法提取 PR 号，使用默认分支: main (原始 ref: $REF)"
            fi
          else
            echo "ref=$REF" >> $GITHUB_OUTPUT
            echo "pr_number=" >> $GITHUB_OUTPUT
            echo "使用指定 ref: $REF"
          fi

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ACCESS_TOKEN }}
          repository: leaperone/MultiPost
          ref: ${{ steps.set-ref.outputs.ref }}

      - name: Check Skip CI
        run: |
          if grep -q "noci" <<< "${{ github.event.client_payload.message || '' }}"; then
            echo "跳过构建: commit message 包含 'noci'"
            exit 78
          fi

      - name: Setup docker-compose
        uses: KengoTODA/actions-setup-docker-compose@v1
        with:
          version: '2.14.2'

      - name: Build Docker images
        run: docker compose -f ./docker/docker-compose-build.yml build

      - name: Login to Aliyun Docker Registry
        if: steps.set-ref.outputs.ref == 'main' || steps.set-ref.outputs.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          registry: registry.cn-hongkong.aliyuncs.com
          username: ${{ secrets.ALIYUN_DOCKER_USERNAME }}
          password: ${{ secrets.ALIYUN_DOCKER_PASSWORD }}

      - name: Tag and Push Docker images
        if: steps.set-ref.outputs.ref == 'main' || steps.set-ref.outputs.ref == 'refs/heads/main'
        run: |
          docker push registry.cn-hongkong.aliyuncs.com/leaperone/multipost:latest
          docker push registry.cn-hongkong.aliyuncs.com/leaperone/multipost:backend-latest
      
      - name: Run Database Migrations
        if: steps.set-ref.outputs.ref == 'main' || steps.set-ref.outputs.ref == 'refs/heads/main'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Execute Migrations
        if: steps.set-ref.outputs.ref == 'main' || steps.set-ref.outputs.ref == 'refs/heads/main'
        run: |
          npm install -g prisma
          export MULTIPOST_DATABASE_URL="${{ secrets.MULTIPOST_DATABASE_URL }}"
          sh prisma/migrate_deploy.sh

      - name: Deploy to Production
        if: steps.set-ref.outputs.ref == 'main' || steps.set-ref.outputs.ref == 'refs/heads/main'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.ALIYUN_HK_HOST }}
          username: ${{ secrets.ALIYUN_CN_USERNAME }}
          port: ${{ secrets.ALIYUN_CN_PORT }}
          key: ${{ secrets.ALIYUN_CN_SSH_PRIVATE_KEY }}
          script: ${{ secrets.DEPLOY_MULTIPOST_SCRIPT }}

  pr-comment:
    needs: build-and-deploy
    if: always() && needs.build-and-deploy.outputs.pr_number != ''
    uses: leaperone/leaperone-releases/.github/workflows/pr-comment.yml@main
    with:
      status: ${{ needs.build-and-deploy.result }}
      ref: leaperone/MultiPost@${{ github.event.client_payload.ref }}
      run_number: ${{ github.run_number }}
      message: ${{ github.event.client_payload.message }}
      author: ${{ github.event.client_payload.author }}
      run_id: ${{ github.run_id }}
      pr_number: ${{ needs.build-and-deploy.outputs.pr_number }}
      repository: leaperone/MultiPost
    secrets:
      ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}

  notify:
    needs: build-and-deploy
    if: always()
    uses: leaperone/leaperone-releases/.github/workflows/feishu-notification.yml@main
    with:
      status: ${{ needs.build-and-deploy.result }}
      ref: leaperone/MultiPost@${{ github.event.client_payload.ref }}
      run_number: ${{ github.run_number }}
      message: ${{ github.event.client_payload.message }}
      author: ${{ github.event.client_payload.author }}
      run_id: ${{ github.run_id }}
    secrets:
      FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
